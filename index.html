<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puantaj Uygulaması</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --bs-primary-rgb: 71, 85, 105;
            --bs-primary: #475569;
        }
        body {
            background-color: #f8fafc;
        }
        .table-responsive {
            max-height: 70vh;
        }
        th:first-child, td:first-child {
            position: sticky;
            left: 0;
            z-index: 2;
            background-color: #fff;
        }
        thead th {
            position: sticky;
            top: 0;
            z-index: 3;
        }
        .day-cell {
            min-width: 50px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
        }
        .weekend-sat {
            background-color: #f1f5f9;
        }
        .weekend-sun {
            background-color: #e2e8f0;
        }
        .status-empty { background-color: #fff; }
        .status-full { background-color: #dcfce7; color: #166534; }
        .status-half { background-color: #ffedd5; color: #9a3412; }
        .status-leave { background-color: #dbeafe; color: #1e40af; }
        .status-sick { background-color: #f3e8ff; color: #581c87; }
        .status-absent { background-color: #fee2e2; color: #991b1b; }
        .status-holiday { background-color: #e5e7eb; color: #374151; }
        .summary-col {
            font-weight: bold;
            background-color: #f1f5f9;
        }
        .editable-personnel:hover {
            background-color: #f0f0f0;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <header class="d-flex flex-wrap align-items-center justify-content-center justify-content-md-between py-3 mb-4 border-bottom">
            <h1 class="h4 mb-3 mb-md-0">Puantaj Uygulaması</h1>
            <div class="d-flex flex-wrap align-items-center justify-content-center gap-2">
                <div class="col-md-auto col-6">
                    <select id="month-select" class="form-select"></select>
                </div>
                <div class="col-md-auto col-6">
                    <select id="year-select" class="form-select"></select>
                </div>
                <button id="add-personnel" class="btn btn-primary"><i class="bi bi-person-plus-fill"></i> Personel Ekle</button>
            </div>
        </header>

        <main>
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="timesheet-table">
                    <thead class="table-light">
                        <!-- Dynamic headers will be inserted here -->
                    </thead>
                    <tbody>
                        <!-- Employee rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div id="legend" class="mt-3">
                <!-- Legend will be inserted here -->
            </div>
        </main>

        <footer class="mt-4 p-3 border-top">
            <div class="d-flex flex-wrap justify-content-center gap-2">
                <button id="download-report" class="btn btn-success"><i class="bi bi-download"></i> Rapor İndir (CSV)</button>
                <button id="backup-data" class="btn btn-info"><i class="bi bi-database-down"></i> Yedekle (JSON)</button>
                <label for="restore-file-input" class="btn btn-warning"><i class="bi bi-database-up"></i> Geri Yükle (JSON)</label>
                <input type="file" id="restore-file-input" class="d-none" accept=".json">
                <button id="reset-app" class="btn btn-danger"><i class="bi bi-trash"></i> Uygulamayı Sıfırla</button>
            </div>
        </footer>
    </div>

    <script>
        class Storage {
            static get(key, defaultValue = []) {
                const value = localStorage.getItem(key);
                return value ? JSON.parse(value) : defaultValue;
            }

            static set(key, value) {
                localStorage.setItem(key, JSON.stringify(value));
            }

            static clear() {
                localStorage.clear();
            }
        }

        class App {
            constructor() {
                this.storageKey = 'employeeTimesheetData';
                this.data = Storage.get(this.storageKey, { personnel: [], attendance: {} });
                this.currentDate = new Date();

                this.elements = {
                    monthSelect: document.getElementById('month-select'),
                    yearSelect: document.getElementById('year-select'),
                    addPersonnelBtn: document.getElementById('add-personnel'),
                    timesheetTable: document.getElementById('timesheet-table'),
                    tableHead: document.querySelector('#timesheet-table thead'),
                    tableBody: document.querySelector('#timesheet-table tbody'),
                    legend: document.getElementById('legend'),
                    downloadReportBtn: document.getElementById('download-report'),
                    backupDataBtn: document.getElementById('backup-data'),
                    restoreFileInput: document.getElementById('restore-file-input'),
                    restoreDataBtn: document.querySelector('label[for="restore-file-input"]'),
                    resetAppBtn: document.getElementById('reset-app'),
                };

                this.statuses = {
                    '': { symbol: '', name: 'Boş', class: 'status-empty' },
                    'X': { symbol: 'X', name: 'Tam Gün', class: 'status-full', value: 1 },
                    '1/2': { symbol: '1/2', name: 'Yarım Gün', class: 'status-half', value: 0.5 },
                    'İ': { symbol: 'İ', name: 'İzinli', class: 'status-leave', value: 0 },
                    'R': { symbol: 'R', name: 'Raporlu', class: 'status-sick', value: 0 },
                    'D': { symbol: 'D', name: 'Devamsız', class: 'status-absent', value: 0 },
                    'T': { symbol: 'T', name: 'Tatil', class: 'status-holiday', value: 0 }
                };

                this.init();
            }

            init() {
                this.populateDateSelectors();
                this.render();
                this.addEventListeners();
            }

            addEventListeners() {
                this.elements.monthSelect.addEventListener('change', () => {
                    this.currentDate.setMonth(this.elements.monthSelect.value);
                    this.render();
                });
                this.elements.yearSelect.addEventListener('change', () => {
                    this.currentDate.setFullYear(this.elements.yearSelect.value);
                    this.render();
                });
                this.elements.addPersonnelBtn.addEventListener('click', () => this.addPersonnel());

                this.elements.tableBody.addEventListener('click', (e) => {
                    if (e.target.classList.contains('day-cell')) {
                        const { personId, day } = e.target.dataset;
                        this.updateAttendance(personId, day, e.target);
                    } else if (e.target.classList.contains('bi-pencil-square')) {
                        this.editPersonnelName(e.target.parentElement.dataset.id);
                    } else if (e.target.classList.contains('bi-trash')) {
                        this.removePersonnel(e.target.dataset.id);
                    }
                });

                this.elements.downloadReportBtn.addEventListener('click', () => this.downloadReport());
                this.elements.backupDataBtn.addEventListener('click', () => this.backupData());
                this.elements.restoreFileInput.addEventListener('change', (e) => this.restoreData(e.target.files[0]));
                this.elements.resetAppBtn.addEventListener('click', () => this.resetApp());
            }

            resetApp() {
                if (confirm("Uygulamayı sıfırlamak istediğinizden emin misiniz? Tüm veriler silinecektir.")) {
                    Storage.clear();
                    this.data = { personnel: [], attendance: {} };
                    this.render();
                    alert("Uygulama sıfırlandı.");
                }
            }

            downloadReport() {
                const month = this.currentDate.getMonth();
                const year = this.currentDate.getFullYear();
                const monthName = this.elements.monthSelect.options[month].text;

                let csvContent = "\uFEFF"; // UTF-8 BOM for Excel
                csvContent += `Puantaj Raporu - ${monthName} ${year}\n`;
                csvContent += "Personel;Çalışılan Gün;İzinli;Devamsız\n";

                const key = `${year}-${month}`;
                this.data.personnel.forEach(person => {
                    const personAttendance = (this.data.attendance[person.id] && this.data.attendance[person.id][key]) || {};
                    let workedDays = 0;
                    let leaveDays = 0;
                    let absentDays = 0;

                    for (const day in personAttendance) {
                        const statusSymbol = personAttendance[day];
                        const status = this.statuses[statusSymbol];
                        if (status) {
                            workedDays += status.value || 0;
                            if (status.symbol === 'İ' || status.symbol === 'R') {
                                leaveDays++;
                            } else if (status.symbol === 'D') {
                                absentDays++;
                            }
                        }
                    }
                    csvContent += `${person.name};${workedDays};${leaveDays};${absentDays}\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `puantaj-raporu-${year}-${monthName}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            backupData() {
                const dataStr = JSON.stringify(this.data, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `puantaj-yedek-${new Date().toISOString().slice(0, 10)}.json`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            restoreData(file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const restoredData = JSON.parse(e.target.result);
                        if (restoredData.personnel && restoredData.attendance) {
                            this.data = restoredData;
                            this.saveData();
                            this.render();
                            alert("Veriler başarıyla geri yüklendi!");
                        } else {
                            alert("Geçersiz yedek dosyası.");
                        }
                    } catch (error) {
                        alert("Yedek dosyası okunurken bir hata oluştu.");
                    }
                };
                reader.readAsText(file);
                this.elements.restoreFileInput.value = ''; // Reset file input
            }

            updateAttendance(personId, day, cell) {
                const month = this.currentDate.getMonth();
                const year = this.currentDate.getFullYear();
                const key = `${year}-${month}`;

                if (!this.data.attendance[personId]) {
                    this.data.attendance[personId] = {};
                }
                if (!this.data.attendance[personId][key]) {
                    this.data.attendance[personId][key] = {};
                }

                const currentStatus = this.data.attendance[personId][key][day] || '';
                const statusSymbols = Object.keys(this.statuses);
                const nextIndex = (statusSymbols.indexOf(currentStatus) + 1) % statusSymbols.length;
                const nextStatusSymbol = statusSymbols[nextIndex];

                this.data.attendance[personId][key][day] = nextStatusSymbol;
                this.saveData();

                // Update cell UI
                cell.textContent = this.statuses[nextStatusSymbol].symbol;
                cell.className = `day-cell ${this.statuses[nextStatusSymbol].class}`;
                this.calculateSummary(personId);
            }

            calculateSummary(personId) {
                const month = this.currentDate.getMonth();
                const year = this.currentDate.getFullYear();
                const key = `${year}-${month}`;
                const personAttendance = (this.data.attendance[personId] && this.data.attendance[personId][key]) || {};

                let workedDays = 0;
                let leaveDays = 0;
                let absentDays = 0;

                for (const day in personAttendance) {
                    const statusSymbol = personAttendance[day];
                    const status = this.statuses[statusSymbol];
                    if (status) {
                        workedDays += status.value || 0;
                        if (status.symbol === 'İ' || status.symbol === 'R') {
                            leaveDays++;
                        } else if (status.symbol === 'D') {
                            absentDays++;
                        }
                    }
                }

                document.querySelector(`[data-summary-worked="${personId}"]`).textContent = workedDays;
                document.querySelector(`[data-summary-leave="${personId}"]`).textContent = leaveDays;
                document.querySelector(`[data-summary-absent="${personId}"]`).textContent = absentDays;
            }

            saveData() {
                Storage.set(this.storageKey, this.data);
            }

            populateDateSelectors() {
                const months = ["Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran", "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"];
                this.elements.monthSelect.innerHTML = months.map((month, index) => `<option value="${index}" ${index === this.currentDate.getMonth() ? 'selected' : ''}>${month}</option>`).join('');

                const currentYear = new Date().getFullYear();
                this.elements.yearSelect.innerHTML = Array.from({ length: 10 }, (_, i) => {
                    const year = currentYear - 5 + i;
                    return `<option value="${year}" ${year === this.currentDate.getFullYear() ? 'selected' : ''}>${year}</option>`;
                }).join('');
            }

            render() {
                this.renderHeader();
                this.renderBody();
                this.renderLegend();
                this.data.personnel.forEach(person => this.calculateSummary(person.id));
            }

            renderHeader() {
                const month = this.currentDate.getMonth();
                const year = this.currentDate.getFullYear();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                let headerHTML = '<tr><th>Personel</th>';
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dayOfWeek = date.getDay();
                    let weekendClass = '';
                    if (dayOfWeek === 6) weekendClass = 'weekend-sat';
                    if (dayOfWeek === 0) weekendClass = 'weekend-sun';
                    headerHTML += `<th class="text-center ${weekendClass}">${day}<br><small>${['Paz', 'Pzt', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt'][dayOfWeek]}</small></th>`;
                }
                headerHTML += '<th class="summary-col">Çalışılan Gün</th><th class="summary-col">İzinli</th><th class="summary-col">Devamsız</th></tr>';
                this.elements.tableHead.innerHTML = headerHTML;
            }

            renderBody() {
                this.elements.tableBody.innerHTML = this.data.personnel.map(person => this.renderRow(person)).join('');
            }

            renderRow(person) {
                const month = this.currentDate.getMonth();
                const year = this.currentDate.getFullYear();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const key = `${year}-${month}`;
                const personAttendance = (this.data.attendance[person.id] && this.data.attendance[person.id][key]) || {};

                let rowHTML = `<tr><td class="editable-personnel" data-id="${person.id}">${person.name} <i class="bi bi-pencil-square"></i> <i class="bi bi-trash text-danger" data-id="${person.id}"></i></td>`;
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dayOfWeek = date.getDay();
                    let weekendClass = '';
                    if (dayOfWeek === 6) weekendClass = 'weekend-sat';
                    if (dayOfWeek === 0) weekendClass = 'weekend-sun';

                    const statusSymbol = personAttendance[day] || '';
                    const status = this.statuses[statusSymbol];
                    rowHTML += `<td class="day-cell ${status.class} ${weekendClass}" data-person-id="${person.id}" data-day="${day}">${status.symbol}</td>`;
                }

                // Placeholder for summary columns
                rowHTML += `<td class="summary-col" data-summary-worked="${person.id}">0</td>`;
                rowHTML += `<td class="summary-col" data-summary-leave="${person.id}">0</td>`;
                rowHTML += `<td class="summary-col" data-summary-absent="${person.id}">0</td>`;

                rowHTML += '</tr>';
                return rowHTML;
            }

            renderLegend() {
                this.elements.legend.innerHTML = Object.values(this.statuses)
                    .filter(s => s.name !== 'Boş')
                    .map(s => `<span class="badge ${s.class} me-2">${s.symbol || '""'}: ${s.name}</span>`)
                    .join('');
            }

            addPersonnel() {
                const name = prompt("Yeni personel adı:", "");
                if (name && name.trim()) {
                    const newPerson = {
                        id: Date.now().toString(),
                        name: name.trim()
                    };
                    this.data.personnel.push(newPerson);
                    this.saveData();
                    this.render();
                }
            }

            editPersonnelName(id) {
                const person = this.data.personnel.find(p => p.id === id);
                if (!person) return;
                const newName = prompt("Yeni adı girin:", person.name);
                if (newName && newName.trim()) {
                    person.name = newName.trim();
                    this.saveData();
                    this.render();
                }
            }

            removePersonnel(id) {
                if (confirm("Bu personeli silmek istediğinizden emin misiniz?")) {
                    this.data.personnel = this.data.personnel.filter(p => p.id !== id);
                    delete this.data.attendance[id];
                    this.saveData();
                    this.render();
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => new App());
    </script>
</body>
</html>