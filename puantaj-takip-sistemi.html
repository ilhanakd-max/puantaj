<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1976D2">
  <title>Puantaj Takip Sistemi</title>
  <style>
    :root {
      --primary: #1976D2;
      --primary-dark: #0D47A1;
      --secondary: #424242;
      --success: #4CAF50;
      --warning: #FF9800;
      --danger: #F44336;
      --info: #2196F3;
      --light: #F5F5F5;
      --dark: #212121;
      --white: #FFFFFF;
      --border: #E0E0E0;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--light);
      color: var(--dark);
      overflow-x: hidden;
    }

    header.app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      color: var(--white);
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    header .menu-toggle {
      background: transparent;
      border: none;
      color: var(--white);
      font-size: 22px;
      padding: 8px;
      cursor: pointer;
      min-width: 44px;
      min-height: 44px;
    }

    header .header-actions button {
      margin-left: 8px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.25);
      color: var(--white);
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      min-width: 44px;
      min-height: 44px;
    }

    .layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: calc(100vh - 60px);
      transition: all 0.3s ease;
    }

    .sidebar {
      background: var(--white);
      border-right: 1px solid var(--border);
      padding: 12px;
      position: relative;
      z-index: 5;
      transition: transform 0.3s ease;
    }

    .sidebar nav a {
      display: block;
      padding: 12px;
      margin-bottom: 8px;
      color: var(--secondary);
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      background: var(--light);
      transition: background 0.2s ease, color 0.2s ease;
      min-height: 44px;
    }

    .sidebar nav a.active, .sidebar nav a:hover {
      background: var(--primary);
      color: var(--white);
    }

    .main-content {
      padding: 16px;
    }

    .card {
      background: var(--white);
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }

    h2 { margin-top: 0; }

    form.grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
      gap: 12px;
    }

    label { font-weight: 600; display: block; margin-bottom: 4px; }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
    }

    button.primary {
      background: var(--primary);
      color: var(--white);
      border: none;
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      min-width: 44px;
      min-height: 44px;
    }

    button.secondary {
      background: var(--light);
      color: var(--secondary);
      border: 1px solid var(--border);
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      min-width: 44px;
      min-height: 44px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
    th { background: var(--light); cursor: pointer; }

    .pill {
      padding: 6px 10px;
      border-radius: 12px;
      font-size: 12px;
      display: inline-block;
    }

    .status-grid {
      overflow: auto;
    }

    .calendar-table {
      border-collapse: collapse;
      width: 100%;
      min-width: 900px;
    }

    .calendar-table th, .calendar-table td {
      border: 1px solid var(--border);
      padding: 6px;
      text-align: center;
      min-width: 44px;
      min-height: 44px;
      position: relative;
    }

    .status-cell {
      border-radius: 6px;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s ease;
    }
    .status-cell:hover { transform: scale(1.02); }

    .status-dropdown {
      position: absolute;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: none;
      z-index: 20;
      padding: 6px;
      width: 220px;
    }

    .status-option {
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }
    .status-option:last-child { margin-bottom: 0; }
    .status-color { width: 16px; height: 16px; border-radius: 4px; margin-right: 8px; }

    .toast {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: var(--dark);
      color: var(--white);
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      opacity: 0;
      transform: translateY(20px);
      animation: toast-in 0.3s forwards;
      z-index: 50;
    }

    @keyframes toast-in { to { opacity: 1; transform: translateY(0);} }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }
    .modal {
      background: var(--white);
      border-radius: 12px;
      max-width: 520px;
      width: calc(100% - 24px);
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    .flex { display: flex; gap: 8px; align-items: center; }
    .space-between { justify-content: space-between; }

    .badge { padding: 4px 8px; border-radius: 999px; font-size: 12px; }

    .status-legend { display: grid; grid-template-columns: repeat(auto-fit,minmax(140px,1fr)); gap: 8px; }

    .bottom-nav {
      display: none;
    }

    @media(max-width: 1023px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { position: fixed; top: 60px; left: 0; height: calc(100vh - 60px); width: 260px; transform: translateX(-100%); box-shadow: 4px 0 12px rgba(0,0,0,0.1); }
      .sidebar.open { transform: translateX(0); background: var(--white); }
      .main-content { padding: 12px; }
      header.app-header { position: sticky; }
    }

    @media(max-width: 599px) {
      header.app-header h1 { font-size: 16px; }
      .calendar-table { min-width: 720px; }
      .bottom-nav { display: flex; position: fixed; bottom: 0; left: 0; right: 0; background: var(--white); border-top: 1px solid var(--border); height: 56px; z-index: 12; }
      .bottom-nav button { flex: 1; border: none; background: transparent; font-size: 12px; color: var(--secondary); }
      body { padding-bottom: 56px; }
    }

    @media print {
      header.app-header, .sidebar, .bottom-nav, #toastContainer, .status-dropdown, .no-print { display: none !important; }
      body { background: #fff; }
      .card { box-shadow: none; border: 1px solid var(--border); }
      .layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <button class="menu-toggle" aria-label="Men√º" id="menuToggle">‚ò∞</button>
    <h1>Puantaj Takip Sistemi</h1>
    <div class="header-actions">
      <button id="btnBackup" title="Yedekle">üíæ</button>
      <button id="btnImport" title="Geri Y√ºkle">üìÇ</button>
      <button id="btnSettings" title="Ayarlar">‚öôÔ∏è</button>
      <input type="file" id="fileImport" accept="application/json" class="no-print" style="display:none;">
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <nav>
        <a href="#" data-page="dashboard" class="active">üìä √ñzet</a>
        <a href="#" data-page="attendance">üìÖ Puantaj</a>
        <a href="#" data-page="employees">üë• √áalƒ±≈üanlar</a>
        <a href="#" data-page="leaves">üèñÔ∏è ƒ∞zinler</a>
        <a href="#" data-page="reports">üìà Raporlar</a>
        <a href="#" data-page="settings">‚öôÔ∏è Ayarlar</a>
      </nav>
    </aside>

    <main class="main-content" id="mainContent" tabindex="-1"></main>
  </div>

  <div class="bottom-nav no-print">
    <button data-page="attendance">üìÖ Puantaj</button>
    <button data-page="employees">üë• √áalƒ±≈üanlar</button>
    <button data-page="leaves">üèñÔ∏è ƒ∞zinler</button>
    <button data-page="reports">üìà Raporlar</button>
  </div>

  <div id="modalContainer"></div>
  <div id="toastContainer"></div>

  <script>
    // Status definitions
    const STATUS_DEFS = [
      { code: "", label: "Bo≈ü", color: "#FFFFFF", text: "" },
      { code: "√á", label: "√áalƒ±≈ütƒ±", color: "#4CAF50" },
      { code: "Y", label: "Yarƒ±m G√ºn", color: "#8BC34A" },
      { code: "Yƒ∞", label: "Yƒ±llƒ±k ƒ∞zin", color: "#2196F3" },
      { code: "R", label: "Raporlu", color: "#FF9800" },
      { code: "√úƒ∞", label: "√úcretsiz ƒ∞zin", color: "#9C27B0" },
      { code: "Mƒ∞", label: "Mazeret ƒ∞zni", color: "#00BCD4" },
      { code: "D", label: "Devamsƒ±z", color: "#F44336" },
      { code: "RT", label: "Resmi Tatil", color: "#E91E63" },
      { code: "HT", label: "Hafta Tatili", color: "#607D8B" },
      { code: "ƒ∞ƒ∞", label: "ƒ∞dari ƒ∞zin", color: "#795548" },
      { code: "Eƒû", label: "Eƒüitim", color: "#3F51B5" },
      { code: "G√ñ", label: "G√∂revli", color: "#009688" },
      { code: "Eƒ∞", label: "Evlilik ƒ∞zni", color: "#FFEB3B", text: '#000' },
      { code: "Dƒ∞", label: "Doƒüum ƒ∞zni", color: "#FF5722" },
      { code: "√ñƒ∞", label: "√ñl√ºm ƒ∞zni", color: "#9E9E9E" },
      { code: "ƒ∞K", label: "ƒ∞≈ü Kazasƒ±", color: "#B71C1C" },
      { code: "FM", label: "Fazla Mesai", color: "#1565C0" }
    ];

    const PuantajApp = {
      state: {
        currentPage: 'dashboard',
        currentMonth: new Date().getMonth(),
        currentYear: new Date().getFullYear(),
        lastSelectedCell: null,
        selectionRange: null,
      },
      data: {
        load() {
          const stored = localStorage.getItem('puantaj-data');
          if (stored) return JSON.parse(stored);
          const seed = {
            version: '1.0',
            exportDate: new Date().toISOString(),
            data: {
              employees: [],
              attendance: {},
              departments: ['Genel'],
              settings: {
                company: { name: '≈ûirket Adƒ±', phone: '', address: '', logo: '' },
                workDays: [1,2,3,4,5],
                dailyHours: 9,
                breakMinutes: 60,
                overtimeMultiplier: 1.5,
                holidays: {}
              },
              leaves: [],
              backups: { lastReminder: null }
            }
          };
          localStorage.setItem('puantaj-data', JSON.stringify(seed));
          return seed;
        },
        save(data) {
          localStorage.setItem('puantaj-data', JSON.stringify(data));
        },
        export() {
          const snapshot = this.load();
          snapshot.exportDate = new Date().toISOString();
          const fileName = `puantaj-yedek-${new Date().toISOString().slice(0,10)}.json`;
          const blob = new Blob([JSON.stringify(snapshot, null, 2)], { type: 'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = fileName;
          a.click();
          PuantajApp.ui.showToast('Yedek indiriliyor');
          PuantajApp.data.setBackupReminder();
        },
        import(json, merge=false) {
          try {
            const parsed = JSON.parse(json);
            if (!parsed.data || !parsed.data.employees) throw new Error('Ge√ßersiz dosya');
            if (merge) {
              const current = this.load();
              const merged = {
                ...current,
                data: {
                  ...current.data,
                  employees: [...current.data.employees, ...parsed.data.employees],
                  attendance: { ...current.data.attendance, ...parsed.data.attendance },
                  departments: Array.from(new Set([...current.data.departments, ...(parsed.data.departments||[])])),
                  settings: { ...current.data.settings, ...parsed.data.settings },
                  leaves: [...current.data.leaves, ...(parsed.data.leaves||[])]
                }
              };
              this.save(merged);
            } else {
              this.save(parsed);
            }
            PuantajApp.ui.showToast('Yedek geri y√ºklendi');
            PuantajApp.ui.renderPage(PuantajApp.state.currentPage);
          } catch(e){
            PuantajApp.ui.showToast('Dosya okunamadƒ±');
          }
        },
        setBackupReminder() {
          const data = this.load();
          data.data.backups.lastReminder = new Date().toISOString();
          this.save(data);
        }
      },
      utils: {
        generateId(prefix) { return `${prefix}_${Math.random().toString(36).slice(2,9)}`; },
        formatDate(date) {
          const d = new Date(date);
          return d.toLocaleDateString('tr-TR');
        },
        daysInMonth(month, year) {
          return new Date(year, month+1, 0).getDate();
        },
        getStatusDef(code) { return STATUS_DEFS.find(s=>s.code===code) || STATUS_DEFS[0]; },
        calculateWorkingDays(start,end) {
          const s = new Date(start); const e = new Date(end);
          let days=0; while(s<=e){ const day=s.getDay(); if(day!==0 && day!==6) days++; s.setDate(s.getDate()+1);} return days;
        }
      },
      employees: {
        add(emp){
          const db = PuantajApp.data.load();
          if (db.data.employees.some(e=>e.sicilNo===emp.sicilNo)) throw new Error('Sicil no benzersiz olmalƒ±');
          emp.id = PuantajApp.utils.generateId('emp');
          emp.createdAt = emp.updatedAt = new Date().toISOString();
          db.data.employees.push(emp);
          PuantajApp.data.save(db);
          return emp;
        },
        update(id, payload){
          const db = PuantajApp.data.load();
          const idx = db.data.employees.findIndex(e=>e.id===id);
          if(idx>-1){ db.data.employees[idx] = { ...db.data.employees[idx], ...payload, updatedAt: new Date().toISOString() }; PuantajApp.data.save(db);} },
        delete(id){
          if(!confirm('Silmek istediƒüinize emin misiniz?')) return;
          const db = PuantajApp.data.load();
          db.data.employees = db.data.employees.filter(e=>e.id!==id);
          PuantajApp.data.save(db);
          PuantajApp.ui.showToast('√áalƒ±≈üan silindi');
        },
        getAll(){ return PuantajApp.data.load().data.employees; },
        getById(id){ return PuantajApp.data.load().data.employees.find(e=>e.id===id); },
        search(term){
          const t = term.toLowerCase();
          return this.getAll().filter(e=> e.adSoyad.toLowerCase().includes(t) || (e.departman||'').toLowerCase().includes(t) || (e.sicilNo||'').includes(term));
        }
      },
      attendance: {
        set(empId, date, status, detail){
          const db = PuantajApp.data.load();
          if(!db.data.attendance[date]) db.data.attendance[date] = {};
          db.data.attendance[date][empId] = { status, ...detail };
          PuantajApp.data.save(db);
        },
        get(empId, date){
          const db = PuantajApp.data.load();
          return db.data.attendance[date]?.[empId];
        },
        getByEmployee(empId){
          const db = PuantajApp.data.load();
          const result = {};
          Object.keys(db.data.attendance).forEach(date=>{
            if(db.data.attendance[date][empId]) result[date]=db.data.attendance[date][empId];
          });
          return result;
        },
        getByDateRange(start,end){
          const db = PuantajApp.data.load();
          const result = {};
          const s = new Date(start); const e=new Date(end);
          while(s<=e){
            const key = s.toISOString().slice(0,10);
            if(db.data.attendance[key]) result[key]=db.data.attendance[key];
            s.setDate(s.getDate()+1);
          }
          return result;
        },
        bulkUpdate(empIds, dates, status){
          empIds.forEach(empId=>{
            dates.forEach(date=>{
              PuantajApp.attendance.set(empId, date, status, {});
            });
          });
        }
      },
      leave: {
        calculate(empId){
          const db = PuantajApp.data.load();
          const emp = db.data.employees.find(e=>e.id===empId);
          const leaves = db.data.leaves.filter(l=>l.empId===empId);
          const used = leaves.reduce((sum,l)=> sum + l.days, 0);
          return { total: emp?.yillikIzinHakki || 14, used, remaining: (emp?.yillikIzinHakki||14) - used };
        },
        add(record){
          const db = PuantajApp.data.load();
          record.id = PuantajApp.utils.generateId('leave');
          db.data.leaves.push(record);
          PuantajApp.data.save(db);
        },
        getAll(){ return PuantajApp.data.load().data.leaves; }
      },
      reports: {
        monthly(month, year){
          const db = PuantajApp.data.load();
          const days = PuantajApp.utils.daysInMonth(month, year);
          const summary = db.data.employees.map(emp=>{
            let worked=0, leave=0, sick=0, absent=0, overtime=0, sgk=0;
            for(let d=1; d<=days; d++){
              const dateKey = new Date(year, month, d).toISOString().slice(0,10);
              const rec = db.data.attendance[dateKey]?.[emp.id];
              if(rec){
                if(rec.status==='√á'){ worked++; sgk++; }
                else if(['Yƒ∞','√úƒ∞','Mƒ∞','RT','HT','ƒ∞ƒ∞','Eƒû','G√ñ','Eƒ∞','Dƒ∞','√ñƒ∞','ƒ∞K'].includes(rec.status)){ leave++; }
                else if(rec.status==='R'){ sick++; }
                else if(rec.status==='D'){ absent++; }
                if(rec.fazlaMesai) overtime += rec.fazlaMesai;
              }
            }
            return { emp, worked, leave, sick, absent, overtime, sgk };
          });
          return summary;
        },
        employee(empId, month, year){
          const db = PuantajApp.data.load();
          const days = PuantajApp.utils.daysInMonth(month, year);
          const chart = {};
          for(let d=1; d<=days; d++){
            const dateKey = new Date(year, month, d).toISOString().slice(0,10);
            const status = db.data.attendance[dateKey]?.[empId]?.status || '';
            chart[status] = (chart[status]||0)+1;
          }
          return chart;
        },
        summary(){
          const db = PuantajApp.data.load();
          const totalEmp = db.data.employees.length;
          const totalLeaves = db.data.leaves.length;
          return { totalEmp, totalLeaves };
        }
      },
      ui: {
        renderPage(page){
          PuantajApp.state.currentPage = page;
          document.querySelectorAll('.sidebar nav a, .bottom-nav button').forEach(a=> a.classList.toggle('active', a.dataset.page===page));
          const main = document.getElementById('mainContent');
          if(page==='employees') return this.renderEmployees(main);
          if(page==='attendance') return this.renderAttendance(main);
          if(page==='leaves') return this.renderLeaves(main);
          if(page==='reports') return this.renderReports(main);
          if(page==='settings') return this.renderSettings(main);
          return this.renderDashboard(main);
        },
        renderDashboard(main){
          const summary = PuantajApp.reports.summary();
          main.innerHTML = `
            <div class="card">
              <h2>√ñzet</h2>
              <div class="status-legend">
                <div class="card" style="background:#E3F2FD;">Toplam √áalƒ±≈üan: <strong>${summary.totalEmp}</strong></div>
                <div class="card" style="background:#E8F5E9;">ƒ∞zin Kayƒ±tlarƒ±: <strong>${summary.totalLeaves}</strong></div>
              </div>
            </div>
            <div class="card">
              <h2>Durum Efsanesi</h2>
              <div class="status-legend">${STATUS_DEFS.map(s=>`<div class="flex" style="gap:6px;"><span class="status-color" style="background:${s.color}; border:1px solid #ccc;"></span><div><strong>${s.code||'Bo≈ü'}</strong><div>${s.label||''}</div></div></div>`).join('')}</div>
            </div>`;
        },
        renderEmployees(main){
          const db = PuantajApp.data.load();
          const departments = db.data.departments || [];
          main.innerHTML = `
            <div class="card">
              <div class="flex space-between">
                <h2>√áalƒ±≈üan Ekle</h2>
                <button class="secondary" id="btnAddDepartment">+ Departman</button>
              </div>
              <form class="grid" id="employeeForm">
                <div><label>Sicil No*</label><input required name="sicilNo"></div>
                <div><label>Ad Soyad*</label><input required name="adSoyad"></div>
                <div><label>TC Kimlik</label><input name="tcNo" pattern="\\d{11}" maxlength="11"></div>
                <div><label>Departman</label><select name="departman">${departments.map(d=>`<option value="${d}">${d}</option>`).join('')}</select></div>
                <div><label>Pozisyon</label><input name="pozisyon"></div>
                <div><label>ƒ∞≈üe Giri≈ü</label><input type="date" name="iseGiris"></div>
                <div><label>Telefon</label><input name="telefon"></div>
                <div><label>E-posta</label><input type="email" name="email"></div>
                <div><label>√áalƒ±≈üma Tipi</label><select name="calismaTipi"><option value="Tam Zamanlƒ±">Tam Zamanlƒ±</option><option>Yarƒ± Zamanlƒ±</option><option>Stajyer</option><option>S√∂zle≈ümeli</option></select></div>
                <div><label>Yƒ±llƒ±k ƒ∞zin Hakkƒ±</label><input type="number" name="yillikIzinHakki" value="14" min="0"></div>
                <div><label>Durum</label><select name="aktif"><option value="true">Aktif</option><option value="false">Pasif</option></select></div>
                <div style="grid-column:1/-1; text-align:right;">
                  <button type="submit" class="primary">Kaydet</button>
                </div>
              </form>
            </div>
            <div class="card">
              <div class="flex space-between">
                <h2>√áalƒ±≈üan Listesi</h2>
                <input id="employeeSearch" placeholder="Ara..." style="max-width:240px;">
              </div>
              <div id="employeeTable"></div>
            </div>`;
          document.getElementById('employeeForm').addEventListener('submit', (e)=>{
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());
            data.aktif = data.aktif==='true';
            data.yillikIzinHakki = Number(data.yillikIzinHakki||14);
            try { PuantajApp.employees.add(data); PuantajApp.ui.showToast('√áalƒ±≈üan eklendi'); form.reset(); } catch(err){ alert(err.message);} 
            PuantajApp.ui.renderEmployees(main);
          });
          document.getElementById('employeeSearch').addEventListener('input', (e)=>{
            PuantajApp.ui.renderEmployeeTable(e.target.value);
          });
          document.getElementById('btnAddDepartment').addEventListener('click', ()=>{
            const name = prompt('Departman adƒ±:');
            if(name){ const data = PuantajApp.data.load(); data.data.departments.push(name); PuantajApp.data.save(data); PuantajApp.ui.renderEmployees(main);} 
          });
          PuantajApp.ui.renderEmployeeTable();
        },
        renderEmployeeTable(filter=''){
          const container = document.getElementById('employeeTable');
          const employees = filter ? PuantajApp.employees.search(filter) : PuantajApp.employees.getAll();
          const rows = employees.map(e=>`<tr>
            <td>${e.sicilNo}</td>
            <td>${e.adSoyad}</td>
            <td>${e.departman||''}</td>
            <td>${e.pozisyon||''}</td>
            <td>${e.aktif?'<span class="badge" style="background:#E8F5E9;color:#2E7D32;">Aktif</span>':'<span class="badge" style="background:#FFEBEE;color:#C62828;">Pasif</span>'}</td>
            <td><button class="secondary" data-action="edit" data-id="${e.id}">D√ºzenle</button> <button class="secondary" data-action="del" data-id="${e.id}">Sil</button></td>
          </tr>`).join('');
          container.innerHTML = `<table><thead><tr><th>Sicil</th><th>Ad Soyad</th><th>Departman</th><th>Pozisyon</th><th>Durum</th><th>ƒ∞≈ülem</th></tr></thead><tbody>${rows}</tbody></table>`;
          container.querySelectorAll('button').forEach(btn=>{
            btn.addEventListener('click', ()=>{
              const id = btn.dataset.id;
              if(btn.dataset.action==='del'){ PuantajApp.employees.delete(id); PuantajApp.ui.renderEmployeeTable(filter);} else {
                PuantajApp.ui.openEmployeeEdit(id);
              }
            });
          });
        },
        openEmployeeEdit(id){
          const emp = PuantajApp.employees.getById(id);
          if(!emp) return;
          PuantajApp.ui.showModal(`<h3>√áalƒ±≈üan D√ºzenle</h3>
            <form id="editForm" class="grid">
              <div><label>Sicil No</label><input name="sicilNo" value="${emp.sicilNo}" required></div>
              <div><label>Ad Soyad</label><input name="adSoyad" value="${emp.adSoyad}" required></div>
              <div><label>Departman</label><input name="departman" value="${emp.departman||''}"></div>
              <div><label>Pozisyon</label><input name="pozisyon" value="${emp.pozisyon||''}"></div>
              <div><label>Aktif</label><select name="aktif"><option value="true" ${emp.aktif?'selected':''}>Aktif</option><option value="false" ${!emp.aktif?'selected':''}>Pasif</option></select></div>
              <div style="grid-column:1/-1;text-align:right;">
                <button type="button" class="secondary" id="closeModal">Vazge√ß</button>
                <button class="primary" type="submit">Kaydet</button>
              </div>
            </form>`);
          document.getElementById('editForm').addEventListener('submit',(e)=>{
            e.preventDefault();
            const payload = Object.fromEntries(new FormData(e.target).entries());
            payload.aktif = payload.aktif==='true';
            PuantajApp.employees.update(id, payload);
            PuantajApp.ui.closeModal();
            PuantajApp.ui.renderEmployeeTable();
          });
          document.getElementById('closeModal').addEventListener('click', PuantajApp.ui.closeModal);
        },
        renderAttendance(main){
          const monthName = new Date(PuantajApp.state.currentYear, PuantajApp.state.currentMonth).toLocaleDateString('tr-TR', { month:'long', year:'numeric' });
          main.innerHTML = `
            <div class="card">
              <div class="flex space-between">
                <div class="flex">
                  <button class="secondary" id="prevMonth">‚óÄ</button>
                  <h2 style="margin:0 8px;">${monthName}</h2>
                  <button class="secondary" id="nextMonth">‚ñ∂</button>
                </div>
                <button class="secondary" id="bulkApply">Toplu Uygula</button>
              </div>
              <div class="status-grid" id="calendarContainer"></div>
            </div>`;
          document.getElementById('prevMonth').onclick=()=>{ if(PuantajApp.state.currentMonth===0){PuantajApp.state.currentMonth=11; PuantajApp.state.currentYear--;} else PuantajApp.state.currentMonth--; this.renderAttendance(main); };
          document.getElementById('nextMonth').onclick=()=>{ if(PuantajApp.state.currentMonth===11){PuantajApp.state.currentMonth=0; PuantajApp.state.currentYear++;} else PuantajApp.state.currentMonth++; this.renderAttendance(main); };
          document.getElementById('bulkApply').onclick=()=>{ this.showBulkModal(); };
          this.renderCalendar();
        },
        renderCalendar(){
          const container = document.getElementById('calendarContainer');
          const employees = PuantajApp.employees.getAll();
          const days = PuantajApp.utils.daysInMonth(PuantajApp.state.currentMonth, PuantajApp.state.currentYear);
          let header = '<thead><tr><th>√áalƒ±≈üan</th>';
          for(let d=1; d<=days; d++){
            const labelDate = new Date(PuantajApp.state.currentYear, PuantajApp.state.currentMonth, d);
            const wd = labelDate.toLocaleDateString('tr-TR', { weekday:'short' });
            header += `<th>${d}<div style="font-size:11px;color:#555;">${wd}</div></th>`;
          }
          header += '</tr></thead>';
          let body = '<tbody>';
          employees.forEach(emp=>{
            body += `<tr><td style="text-align:left; font-weight:700;">${emp.adSoyad}</td>`;
            for(let d=1; d<=days; d++){
              const date = new Date(PuantajApp.state.currentYear, PuantajApp.state.currentMonth, d).toISOString().slice(0,10);
              const rec = PuantajApp.attendance.get(emp.id, date) || {status:''};
              const def = PuantajApp.utils.getStatusDef(rec.status);
              const color = def.color || '#fff';
              const textColor = def.text || (rec.status ? '#fff' : '#000');
              body += `<td><div class="status-cell" tabindex="0" data-emp="${emp.id}" data-date="${date}" style="background:${color};color:${textColor};">${rec.status||''}</div></td>`;
            }
            body += '</tr>';
          });
          body += '</tbody>';
          container.innerHTML = `<table class="calendar-table">${header}${body}</table>`;
          container.querySelectorAll('.status-cell').forEach(cell=>{
            cell.addEventListener('click', (e)=> PuantajApp.ui.openStatusDropdown(e.currentTarget));
            cell.addEventListener('contextmenu', (e)=>{ e.preventDefault(); PuantajApp.ui.openStatusDropdown(e.currentTarget);});
            cell.addEventListener('dblclick', (e)=> PuantajApp.ui.openTimeModal(e.currentTarget));
            cell.addEventListener('mousedown', (e)=>{
              if(e.shiftKey && PuantajApp.state.lastSelectedCell){
                const last = PuantajApp.state.lastSelectedCell;
                PuantajApp.state.selectionRange = { start:last.dataset.date, end:cell.dataset.date };
              }
              PuantajApp.state.lastSelectedCell = cell;
            });
          });
        },
        openTimeModal(target){
          const empId = target.dataset.emp;
          const date = target.dataset.date;
          const record = PuantajApp.attendance.get(empId, date) || {};
          const emp = PuantajApp.employees.getById(empId);
          this.showModal(`<h3>${emp?.adSoyad} - ${date}</h3>
            <form id="timeForm" class="grid">
              <div><label>Durum</label><select name="status">${STATUS_DEFS.map(s=>`<option value="${s.code}" ${record.status===s.code?'selected':''}>${s.code||'Bo≈ü'} - ${s.label||''}</option>`).join('')}</select></div>
              <div><label>Giri≈ü Saati</label><input name="giris" type="time" value="${record.giris||''}"></div>
              <div><label>√áƒ±kƒ±≈ü Saati</label><input name="cikis" type="time" value="${record.cikis||''}"></div>
              <div><label>Mola (dk)</label><input name="mola" type="number" value="${record.mola||60}"></div>
              <div><label>Not</label><textarea name="not">${record.not||''}</textarea></div>
              <div style="grid-column:1/-1;text-align:right;"><button type="button" class="secondary" id="closeModal">Vazge√ß</button> <button class="primary">Kaydet</button></div>
            </form>`);
          document.getElementById('closeModal').onclick = this.closeModal;
          document.getElementById('timeForm').onsubmit=(e)=>{
            e.preventDefault();
            const fd = new FormData(e.target);
            const giris = fd.get('giris'); const cikis = fd.get('cikis');
            let calismaSuresi=0; let fazlaMesai=0;
            if(giris && cikis){
              const [gh,gm]=giris.split(':').map(Number); const [ch,cm]=cikis.split(':').map(Number);
              calismaSuresi = ((ch*60+cm) - (gh*60+gm)) - Number(fd.get('mola')||0);
              if(calismaSuresi > (PuantajApp.data.load().data.settings.dailyHours*60)) fazlaMesai = calismaSuresi - (PuantajApp.data.load().data.settings.dailyHours*60);
            }
            PuantajApp.attendance.set(empId, date, fd.get('status'), {
              giris,
              cikis,
              mola: Number(fd.get('mola')||0),
              calismaSuresi,
              fazlaMesai,
              not: fd.get('not')
            });
            PuantajApp.ui.showToast('Zaman kaydedildi');
            PuantajApp.ui.closeModal();
            PuantajApp.ui.renderCalendar();
          }
        },
        openStatusDropdown(target){
          this.closeDropdown();
          const dropdown = document.createElement('div');
          dropdown.className = 'status-dropdown';
          dropdown.innerHTML = STATUS_DEFS.map(s=>`<div class="status-option" data-code="${s.code}" style="background:${s.color};color:${s.text|| (s.code ? '#fff':'#000')};"><span class="status-color" style="background:${s.color}; border:1px solid #ccc;"></span>${s.code||'Bo≈ü'} - ${s.label||''}</div>`).join('');
          document.body.appendChild(dropdown);
          const rect = target.getBoundingClientRect();
          dropdown.style.left = rect.left + 'px';
          dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
          dropdown.style.display = 'block';
          const applyStatus = (code)=>{
            const empId = target.dataset.emp;
            const dates = this.getSelectedDates(target.dataset.date);
            PuantajApp.attendance.bulkUpdate([empId], dates, code);
            PuantajApp.ui.renderCalendar();
            PuantajApp.ui.showToast('Kaydedildi');
          };
          dropdown.querySelectorAll('.status-option').forEach(opt=> opt.addEventListener('click', ()=>{ applyStatus(opt.dataset.code); this.closeDropdown(); }));
          document.addEventListener('click', this._dropdownCloseHandler = (ev)=>{ if(!dropdown.contains(ev.target)) this.closeDropdown(); });
        },
        getSelectedDates(baseDate){
          if(!PuantajApp.state.selectionRange) return [baseDate];
          const { start, end } = PuantajApp.state.selectionRange;
          const s = new Date(start); const e = new Date(end);
          if(s>e){ const tmp = s; s=e; e=tmp; }
          const dates=[]; const cur = new Date(s);
          while(cur<=e){ dates.push(cur.toISOString().slice(0,10)); cur.setDate(cur.getDate()+1);} 
          PuantajApp.state.selectionRange = null;
          return dates;
        },
        closeDropdown(){
          const dd = document.querySelector('.status-dropdown');
          if(dd) dd.remove();
          if(this._dropdownCloseHandler){ document.removeEventListener('click', this._dropdownCloseHandler); this._dropdownCloseHandler=null; }
        },
        showBulkModal(){
          const employees = PuantajApp.employees.getAll();
          const days = PuantajApp.utils.daysInMonth(PuantajApp.state.currentMonth, PuantajApp.state.currentYear);
          const start = new Date(PuantajApp.state.currentYear, PuantajApp.state.currentMonth,1).toISOString().slice(0,10);
          const end = new Date(PuantajApp.state.currentYear, PuantajApp.state.currentMonth,days).toISOString().slice(0,10);
          this.showModal(`<h3>Toplu Durum</h3>
            <form id="bulkForm" class="grid">
              <div><label>√áalƒ±≈üan</label><select name="empId"><option value="all">T√ºm√º</option>${employees.map(e=>`<option value="${e.id}">${e.adSoyad}</option>`).join('')}</select></div>
              <div><label>Ba≈ülangƒ±√ß</label><input type="date" name="start" value="${start}"></div>
              <div><label>Biti≈ü</label><input type="date" name="end" value="${end}"></div>
              <div style="grid-column:1/-1;">${STATUS_DEFS.map(s=>`<label class="flex" style="align-items:center;"><input type="radio" name="status" value="${s.code}" required> <span class="status-color" style="background:${s.color}; border:1px solid #ccc;"></span> ${s.code||'Bo≈ü'} - ${s.label||''}</label>`).join('')}</div>
              <div style="grid-column:1/-1;text-align:right;"><button type="button" class="secondary" id="closeModal">Vazge√ß</button> <button class="primary" type="submit">Uygula</button></div>
            </form>`);
          document.getElementById('bulkForm').onsubmit=(e)=>{
            e.preventDefault();
            const fd = new FormData(e.target);
            const empId = fd.get('empId');
            const startDate = fd.get('start');
            const endDate = fd.get('end');
            const status = fd.get('status');
            const dates = PuantajApp.attendance.getByDateRange(startDate,endDate);
            const list=[]; const s=new Date(startDate); const eDate=new Date(endDate); while(s<=eDate){ list.push(s.toISOString().slice(0,10)); s.setDate(s.getDate()+1);} 
            const empIds = empId==='all' ? employees.map(e=>e.id) : [empId];
            PuantajApp.attendance.bulkUpdate(empIds, list, status);
            PuantajApp.ui.showToast('Toplu uygulandƒ±');
            PuantajApp.ui.closeModal();
            PuantajApp.ui.renderCalendar();
          };
          document.getElementById('closeModal').onclick = this.closeModal;
        },
        renderLeaves(main){
          const employees = PuantajApp.employees.getAll();
          main.innerHTML = `<div class="card">
            <h2>ƒ∞zin Kaydƒ±</h2>
            <form class="grid" id="leaveForm">
              <div><label>√áalƒ±≈üan</label><select name="empId" required>${employees.map(e=>`<option value="${e.id}">${e.adSoyad}</option>`).join('')}</select></div>
              <div><label>ƒ∞zin T√ºr√º</label><select name="type"><option>Yƒ±llƒ±k</option><option>√úcretsiz</option><option>Mazeret</option><option>Rapor</option></select></div>
              <div><label>Ba≈ülangƒ±√ß</label><input type="date" name="start" required></div>
              <div><label>Biti≈ü</label><input type="date" name="end" required></div>
              <div><label>G√ºn Sayƒ±sƒ±</label><input type="number" name="days" min="1" required></div>
              <div><label>Not</label><textarea name="note"></textarea></div>
              <div style="grid-column:1/-1;text-align:right;"><button class="primary">Kaydet</button></div>
            </form>
          </div>
          <div class="card"><h2>ƒ∞zin Kayƒ±tlarƒ±</h2><div id="leaveTable"></div></div>`;
          document.getElementById('leaveForm').addEventListener('change',(e)=>{
            if(['start','end'].includes(e.target.name)){
              const s = e.target.form.start.value; const ed=e.target.form.end.value; if(s&&ed){ const days = PuantajApp.utils.calculateWorkingDays(s,ed); e.target.form.days.value = days; }
            }
          });
          document.getElementById('leaveForm').addEventListener('submit',(e)=>{
            e.preventDefault();
            const fd = new FormData(e.target);
            const record = Object.fromEntries(fd.entries());
            record.days = Number(record.days||0);
            PuantajApp.leave.add(record);
            PuantajApp.ui.showToast('ƒ∞zin kaydedildi');
            PuantajApp.ui.renderLeaves(main);
          });
          this.renderLeaveTable();
        },
        renderLeaveTable(){
          const container = document.getElementById('leaveTable');
          const rows = PuantajApp.leave.getAll().map(l=>{
            const emp = PuantajApp.employees.getById(l.empId);
            return `<tr><td>${emp?.adSoyad||''}</td><td>${l.type}</td><td>${l.start}</td><td>${l.end}</td><td>${l.days}</td><td>${l.note||''}</td></tr>`;
          }).join('');
          container.innerHTML = `<table><thead><tr><th>√áalƒ±≈üan</th><th>T√ºr</th><th>Ba≈ülangƒ±√ß</th><th>Biti≈ü</th><th>G√ºn</th><th>Not</th></tr></thead><tbody>${rows}</tbody></table>`;
        },
        renderReports(main){
          const month = PuantajApp.state.currentMonth;
          const year = PuantajApp.state.currentYear;
          const summary = PuantajApp.reports.monthly(month, year);
          main.innerHTML = `<div class="card">
            <h2>Aylƒ±k Puantaj Raporu (${new Date(year,month).toLocaleDateString('tr-TR',{month:'long',year:'numeric'})})</h2>
            <table><thead><tr><th>Ad Soyad</th><th>√áalƒ±≈üƒ±lan</th><th>ƒ∞zinli</th><th>Raporlu</th><th>Devamsƒ±z</th><th>Fazla Mesai (dk)</th><th>SGK G√ºn</th></tr></thead><tbody>
              ${summary.map(s=>`<tr><td>${s.emp.adSoyad}</td><td>${s.worked}</td><td>${s.leave}</td><td>${s.sick}</td><td>${s.absent}</td><td>${s.overtime}</td><td>${s.sgk}</td></tr>`).join('')}
            </tbody></table>
          </div>
          <div class="card"><h2>√áalƒ±≈üan Detay</h2>
            <select id="reportEmployee">${PuantajApp.employees.getAll().map(e=>`<option value="${e.id}">${e.adSoyad}</option>`)}</select>
            <div id="detailChart"></div>
          </div>`;
          const select = document.getElementById('reportEmployee');
          select.onchange = ()=> this.renderEmployeeChart(select.value);
          if(select.value) this.renderEmployeeChart(select.value);
        },
        renderEmployeeChart(empId){
          const data = PuantajApp.reports.employee(empId, PuantajApp.state.currentMonth, PuantajApp.state.currentYear);
          const total = Object.values(data).reduce((a,b)=>a+b,0) || 1;
          const items = Object.keys(data).map(code=>{ const def = PuantajApp.utils.getStatusDef(code); return `<div class="flex" style="gap:6px;"><span class="status-color" style="background:${def.color}; border:1px solid #ccc;"></span>${def.label||'Bo≈ü'}: ${data[code]} g√ºn (%${Math.round(data[code]/total*100)})</div>`; }).join('');
          document.getElementById('detailChart').innerHTML = items || 'Kayƒ±t yok';
        },
        renderSettings(main){
          const db = PuantajApp.data.load();
          const s = db.data.settings;
          main.innerHTML = `<div class="card">
            <h2>Ayarlar</h2>
            <form class="grid" id="settingsForm">
              <div><label>≈ûirket Adƒ±</label><input name="companyName" value="${s.company.name}"></div>
              <div><label>Telefon</label><input name="companyPhone" value="${s.company.phone}"></div>
              <div><label>Adres</label><textarea name="companyAddress">${s.company.address}</textarea></div>
              <div><label>G√ºnl√ºk √áalƒ±≈üma Saati</label><input type="number" name="dailyHours" value="${s.dailyHours}"></div>
              <div><label>Mola (dk)</label><input type="number" name="breakMinutes" value="${s.breakMinutes}"></div>
              <div><label>Fazla Mesai Katsayƒ±sƒ±</label><input type="number" step="0.1" name="overtimeMultiplier" value="${s.overtimeMultiplier}"></div>
              <div style="grid-column:1/-1;text-align:right;"><button class="primary">Kaydet</button></div>
            </form>
          </div>`;
          document.getElementById('settingsForm').onsubmit=(e)=>{
            e.preventDefault();
            const fd = new FormData(e.target);
            s.company.name = fd.get('companyName');
            s.company.phone = fd.get('companyPhone');
            s.company.address = fd.get('companyAddress');
            s.dailyHours = Number(fd.get('dailyHours'));
            s.breakMinutes = Number(fd.get('breakMinutes'));
            s.overtimeMultiplier = Number(fd.get('overtimeMultiplier'));
            const db = PuantajApp.data.load();
            db.data.settings = s;
            PuantajApp.data.save(db);
            PuantajApp.ui.showToast('Ayarlar kaydedildi');
          };
        },
        showModal(content){
          const backdrop = document.createElement('div');
          backdrop.className = 'modal-backdrop';
          backdrop.innerHTML = `<div class="modal">${content}</div>`;
          document.getElementById('modalContainer').appendChild(backdrop);
          backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) PuantajApp.ui.closeModal(); });
        },
        closeModal(){
          document.getElementById('modalContainer').innerHTML='';
        },
        showToast(msg){
          const t = document.createElement('div'); t.className='toast'; t.textContent=msg; document.getElementById('toastContainer').appendChild(t);
          setTimeout(()=>{ t.style.opacity=0; setTimeout(()=>t.remove(), 500); }, 2500);
        }
      }
    };

    // Event bindings
    document.getElementById('menuToggle').onclick = ()=> document.getElementById('sidebar').classList.toggle('open');
    document.querySelectorAll('.sidebar nav a, .bottom-nav button').forEach(link=>{
      link.addEventListener('click', (e)=>{
        e.preventDefault();
        PuantajApp.ui.renderPage(link.dataset.page);
        document.getElementById('sidebar').classList.remove('open');
      });
    });

    document.getElementById('btnBackup').onclick = ()=> PuantajApp.data.export();
    document.getElementById('btnImport').onclick = ()=> document.getElementById('fileImport').click();
    document.getElementById('fileImport').addEventListener('change', (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        PuantajApp.ui.showModal(`<h3>Geri Y√ºkleme</h3><p>Mevcut verilerin √ºzerine yazƒ±lsƒ±n mƒ±?</p><div class="flex" style="justify-content:flex-end;"><button class="secondary" id="mergeImport">Birle≈ütir</button><button class="primary" id="overwriteImport">√úzerine Yaz</button></div>`);
        document.getElementById('mergeImport').onclick = ()=>{ PuantajApp.data.import(reader.result, true); PuantajApp.ui.closeModal(); };
        document.getElementById('overwriteImport').onclick = ()=>{ PuantajApp.data.import(reader.result, false); PuantajApp.ui.closeModal(); };
      };
      reader.readAsText(file);
    });

    // reminder
    const remindBackup = ()=>{
      const data = PuantajApp.data.load();
      const last = data.data.backups.lastReminder ? new Date(data.data.backups.lastReminder) : null;
      const now = new Date();
      if(!last || (now - last) > 7*24*60*60*1000){
        PuantajApp.ui.showToast('7 g√ºnde bir yedek almayƒ± unutmayƒ±n');
        PuantajApp.data.setBackupReminder();
      }
    };

    window.addEventListener('DOMContentLoaded', ()=>{
      PuantajApp.ui.renderPage('dashboard');
      remindBackup();
    });
  </script>
</body>
</html>
